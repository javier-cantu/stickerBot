// sb018_expresion_regular.js
// ahora quiero que el comando de quiero stickers de funcione con mas variaciones.
// Con una expresion regular. 

const qrcode = require('qrcode-terminal');
const { Client, LocalAuth, MessageMedia } = require('whatsapp-web.js');
const fs = require('fs');
const path = require('path');

// Inicializar cliente de WhatsApp
const client = new Client({
    authStrategy: new LocalAuth(),
});

// Variable para guardar data de los stickers
let stickersData = {};
// Variable para guardar las solicitudes 
const solicitudesStickers = new Map();
// Variable para la Expresion Regular mejorada para cubrir mas opciones
const regexQuieroStickers = /^(quiero|necesito|tienen) (el )?(sticker|stickers) de(l| la| los| las)?\s+/;

// Generar QR para escanear
client.on('qr', (qr) => {
    console.log('\nScan this QR code to log in:\n');
    qrcode.generate(qr, { small: true });
});

// Cuando el cliente est√° listo
client.on('ready', () => {
    console.log('The bot is ready!');
    // Cargar data de stickers.json
    cargarStickersData();
});


// Responder a un mensaje simple de cualquier usuario
client.on('message', async (message) => {
    const comando = message.body.toLowerCase().trim();
    if (comando === '!ping') return manejarPing(message);
    // Aqui se usa la expresion regular para tener mas opciones
    if (regexQuieroStickers.test(comando)) {
        const palabrasClave = comando.replace(regexQuieroStickers, '').trim();
        return manejarQuieroStickers(message, palabrasClave);
    }    
    if (comando.startsWith('mandame stickers de')) return manejarMandameStickers(message, comando);
    if (/^\d+$/.test(comando)) return manejarSeleccionNumerica(message, parseInt(comando, 10));
});

// Responde a los mensajes del host
client.on('message_create', async (message) => {
    if (message.fromMe) {
        const comando = message.body.toLowerCase().trim();
        if (comando === '!ping') return manejarPing(message);
        if (comando === '!refresh') return manejarRefresh(message);
        // Aqui se usa la expresion regular para tener mas opciones
        if (regexQuieroStickers.test(comando)) {
            const palabrasClave = comando.replace(regexQuieroStickers, '').trim();
            return manejarQuieroStickers(message, palabrasClave);
        }        
        if (comando.startsWith('mandame stickers de')) return manejarMandameStickers(message, comando);
        if (/^\d+$/.test(comando)) return manejarSeleccionNumerica(message, parseInt(comando, 10));
    }
});































// ================================================
// Funciones auxiliares
// ================================================

/**
 * Carga el archivo JSON de stickers y lo almacena en la variable `stickersData`.
 * 
 * üîπ **Entrada:** No recibe par√°metros.
 * üîπ **Salida:** No retorna valores, pero actualiza la variable global `stickersData`.
 * 
 * üìå **Descripci√≥n:**
 * - Lee el archivo `stickers.json` desde el directorio `media/stickers/`.
 * - Convierte su contenido en un objeto JSON y lo almacena en `stickersData`.
 * - Muestra en consola informaci√≥n sobre el tiempo de carga y los stickers cargados.
 * - Si el archivo no existe, imprime un mensaje de error en la consola.
 */
function cargarStickersData() {
    const stickersPath = path.join(__dirname, '..', 'media', 'stickers', 'stickers.json');
    const startTime = Date.now(); // Tiempo de inicio
    console.log('Inicio de carga del archivo stickers.json:', new Date(startTime).toLocaleString());

    if (fs.existsSync(stickersPath)) {
        const rawData = fs.readFileSync(stickersPath);
        stickersData = JSON.parse(rawData);

        const endTime = Date.now(); // Tiempo final
        console.log('Stickers data loaded:', stickersData);
        console.log('Fin de carga del archivo stickers.json:', new Date(endTime).toLocaleString());
        console.log(`Tiempo total de carga: ${(endTime - startTime) / 1000} segundos.`);
    } else {
        console.log('No stickers.json file found.');
    }
}


/**
 * Busca stickers que coincidan con las palabras clave proporcionadas.
 * 
 * üîπ **Entrada:** 
 *   - `palabrasClave` *(string)*: Texto ingresado por el usuario con palabras clave separadas por espacios.
 * 
 * üîπ **Salida:** 
 *   - *(Array de strings)*: Lista de nombres de archivos de stickers que coinciden con las palabras clave.
 * 
 * üìå **Descripci√≥n:**
 * - Convierte las palabras clave a min√∫sculas y las divide en un array.
 * - Filtra palabras excluidas (prefijadas con `!`) y palabras incluidas.
 * - Busca en `stickersData` los stickers que contienen todas las palabras incluidas y ninguna de las excluidas.
 * - Retorna una lista de nombres de archivos de stickers que coinciden con los criterios.
 * 
 * ‚ö† **Nota:**
 * - Si no hay coincidencias, retorna un array vac√≠o.
 * - Es sensible a las etiquetas definidas en `stickers.json`.
 */
function buscarStickersPorPalabrasClave(palabrasClave) {
    const palabras = palabrasClave.toLowerCase().split(' ');
    const palabrasIncluidas = palabras.filter(palabra => !palabra.startsWith('!'));
    const palabrasExcluidas = palabras.filter(palabra => palabra.startsWith('!')).map(palabra => palabra.slice(1));

    console.log('Palabras clave incluidas:', palabrasIncluidas);
    console.log('Palabras clave excluidas:', palabrasExcluidas);

    const resultados = [];

    // Buscar en el stickersData
    for (const [stickerFile, tags] of Object.entries(stickersData)) {
        const tagsLower = tags.map(tag => tag.toLowerCase());

        // Verificar que cumpla con las palabras incluidas y no tenga ninguna palabra excluida
        if (
            palabrasIncluidas.every(palabra => tagsLower.includes(palabra)) &&
            palabrasExcluidas.every(palabra => !tagsLower.includes(palabra))
        ) {
            resultados.push(stickerFile);
        }
    }
    return resultados;
}


/**
 * Env√≠a un sticker espec√≠fico al usuario en WhatsApp.
 * 
 * üîπ **Entrada:** 
 *   - `stickerFile` *(string)*: Nombre del archivo del sticker (incluyendo su extensi√≥n).
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp al cual se responder√° con el sticker.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero env√≠a un sticker como respuesta al mensaje del usuario.
 * 
 * üìå **Descripci√≥n:**
 * - Construye la ruta absoluta del sticker en el directorio `media/stickers/`.
 * - Verifica si el archivo del sticker existe antes de intentar enviarlo.
 * - Si el archivo no existe, responde al usuario con un mensaje de error.
 * - Si el archivo existe, lo lee en base64 y lo convierte en un objeto `MessageMedia` para enviarlo como sticker.
 * - Maneja posibles errores en la lectura o env√≠o del archivo y notifica al usuario en caso de fallo.
 * 
 * ‚ö† **Nota:**
 * - El archivo debe estar en formato `webp` y ubicado en `media/stickers/`.
 * - Si el sticker no se encuentra o hay un error, el bot responde con un mensaje en texto en lugar de quedarse en silencio.
 */
function enviarSticker(stickerFile, message) {
    const stickerPath = path.join(__dirname, '..', 'media', 'stickers', stickerFile);

    if (!fs.existsSync(stickerPath)) {
        console.error(`Sticker file not found: ${stickerPath}`);
        message.reply(`No se encontr√≥ el archivo del sticker: ${stickerFile}`);
        return;
    }

    try {
        const stickerData = fs.readFileSync(stickerPath).toString('base64');
        const sticker = new MessageMedia('image/webp', stickerData);
        message.reply(sticker, undefined, { sendMediaAsSticker: true });
    } catch (error) {
        console.error(`Error al enviar el sticker: ${stickerFile}`, error);
        message.reply(`Hubo un error al enviar el sticker: ${stickerFile}`);
    }
}



// ================================================
// Funciones para los comandos:
// ================================================
/**
 * Responde con "pong!" cuando se recibe el comando "!ping".
 * 
 * üîπ **Entrada:** 
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp que contiene la informaci√≥n del usuario y el chat.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero env√≠a una respuesta de texto con "pong!" al usuario.
 * 
 * üìå **Descripci√≥n:**
 * - Elimina cualquier selecci√≥n avctia en `solicitudesStickers` para reiniciar la sesi√≥n del usuario.
 * - Responde al mensaje con el texto `"pong!"`, √∫til para verificar si el bot est√° en l√≠nea.
 * 
 * ‚ö† **Nota:**
 * - Este comando es accesible tanto para el host como para otros usuarios.
 * - Se usa generalmente como prueba de conectividad o respuesta r√°pida del bot.
 */
function manejarPing(message) {
    solicitudesStickers.delete(message.from);
    message.reply('pong!');
}


/**
 * Recarga el archivo JSON de stickers y elimina cualquier selecci√≥n activa del usuario.
 * 
 * üîπ **Entrada:** 
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp que contiene la informaci√≥n del usuario y el chat.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero env√≠a un mensaje de confirmaci√≥n o error al usuario.
 * 
 * üìå **Descripci√≥n:**
 * - Elimina cualquier selecci√≥n activa en `solicitudesStickers`, asegurando que los usuarios no mantengan una selecci√≥n obsoleta.
 * - Llama a la funci√≥n `cargarStickersData()` para volver a leer y actualizar la data de stickers desde `stickers.json`.
 * - Si la recarga es exitosa, responde al usuario con `"Stickers recargados exitosamente."`.
 * - Si ocurre un error al leer el archivo, captura la excepci√≥n y notifica al usuario con `"Error al recargar stickers.json."`.
 * 
 * ‚ö† **Nota:**
 * - Solo el host puede ejecutar este comando (`!refresh`).
 * - Se recomienda usarlo despu√©s de agregar o modificar stickers en `stickers.json`.
 */
function manejarRefresh(message) {
    solicitudesStickers.delete(message.from);
    try {
        cargarStickersData();
        message.reply('Stickers recargados exitosamente.');
    } catch (error) {
        console.error('Error al recargar stickers.json:', error);
        message.reply('Error al recargar stickers.json.');
    }
}


/**
 * Busca y env√≠a autom√°ticamente stickers que coincidan con las palabras clave proporcionadas.
 * 
 * üîπ **Entrada:** 
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp que contiene la informaci√≥n del usuario y el chat.
 *   - `comando` *(string)*: Texto del mensaje enviado por el usuario, incluyendo el comando y las palabras clave.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero responde al usuario con una lista de stickers encontrados y env√≠a hasta 5 stickers autom√°ticamente.
 * 
 * üìå **Descripci√≥n:**
 * - Elimina cualquier selecci√≥n activa en `solicitudesStickers` antes de procesar el nuevo comando.
 * - Extrae las palabras clave eliminando el prefijo `"mandame stickers de"`.
 * - Si el usuario no proporciona palabras clave, responde con un mensaje de error.
 * - Llama a `buscarStickersPorPalabrasClave(palabrasClave)` para encontrar stickers que coincidan con la b√∫squeda.
 * - Si hay resultados:
 *   - Genera y env√≠a una lista numerada con los stickers encontrados.
 *   - Env√≠a hasta 5 stickers, con un peque√±o retraso entre cada uno para evitar saturar el chat.
 * - Si no hay resultados, responde con `"No encontr√© stickers para esas palabras clave."`.
 * 
 * ‚ö† **Nota:**
 * - Este comando est√° disponible tanto para el host como para otros usuarios.
 * - Los stickers se env√≠an autom√°ticamente sin requerir confirmaci√≥n del usuario.
 * - Para seleccionar un sticker espec√≠fico en lugar de recibir varios, se debe usar `"quiero stickers de"`.
 */
function manejarMandameStickers(message, comando) {
    solicitudesStickers.delete(message.from);
    const palabrasClave = comando.replace('mandame stickers de', '').trim();
    if (!palabrasClave) {
        return message.reply('Por favor incluye palabras clave despu√©s de "mandame stickers de".');
    }
    const resultados = buscarStickersPorPalabrasClave(palabrasClave);
    if (resultados.length > 0) {
        const listaEnumerada = resultados.map((sticker, index) => `${index + 1}. ${sticker}`).join('\n');
        message.reply(`Encontr√© estos stickers:\n${listaEnumerada}`);
        for (const stickerFile of resultados.slice(0, 5)) {
            setTimeout(() => enviarSticker(stickerFile, message), 1000);
        }
    } else {
        message.reply('No encontr√© stickers para esas palabras clave.');
    }
}


/**
 * Busca stickers seg√∫n palabras clave y permite al usuario seleccionar uno enviando un n√∫mero.
 * 
 * üîπ **Entrada:** 
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp que contiene la informaci√≥n del usuario y el chat.
 *   - `comando` *(string)*: Texto del mensaje enviado por el usuario, incluyendo el comando y las palabras clave.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero responde con una lista numerada de stickers encontrados y guarda la selecci√≥n para permitir la elecci√≥n posterior.
 * 
 * üìå **Descripci√≥n:**
 * - Elimina cualquier selecci√≥n activa en `solicitudesStickers` antes de procesar el nuevo comando.
 * - Extrae las palabras clave eliminando el prefijo `"quiero stickers de"`.
 * - Si el usuario no proporciona palabras clave, responde con un mensaje de error.
 * - Llama a `buscarStickersPorPalabrasClave(palabrasClave)` para encontrar stickers que coincidan con la b√∫squeda.
 * - Si hay resultados:
 *   - Genera y env√≠a una lista numerada de los stickers encontrados.
 *   - Guarda la selecci√≥n en `solicitudesStickers` para que el usuario pueda elegir un sticker enviando un n√∫mero.
 *   - Establece un temporizador de 60 segundos, tras el cual la selecci√≥n se elimina autom√°ticamente si el usuario no elige un n√∫mero.
 * - Si no hay resultados, responde con `"No encontr√© stickers para esas palabras clave."`.
 * 
 * ‚ö† **Nota:**
 * - Este comando est√° disponible tanto para el host como para otros usuarios.
 * - A diferencia de `"mandame stickers de"`, este comando permite al usuario elegir un sticker en lugar de recibir varios autom√°ticamente.
 * - La selecci√≥n expira despu√©s de 60 segundos si el usuario no responde con un n√∫mero v√°lido.
 */
function manejarQuieroStickers(message, comando) {
    solicitudesStickers.delete(message.from);
    const palabrasClave = comando.replace('quiero stickers de', '').trim();
    if (!palabrasClave) {
        return message.reply('Por favor incluye palabras clave despu√©s de "quiero stickers de".');
    }
    const resultados = buscarStickersPorPalabrasClave(palabrasClave);
    if (resultados.length > 0) {
        const listaEnumerada = resultados.map((sticker, index) => `${index + 1}. ${sticker}`).join('\n');
        message.reply(`Estos son todos los stickers que encontr√© con esas palabras clave:\n\n${listaEnumerada}`);
        solicitudesStickers.set(message.from, { resultados, mensajeOriginal: message });
        setTimeout(() => {
            solicitudesStickers.delete(message.from);
            console.log(`Selecci√≥n de stickers eliminada para ${message.from} por inactividad.`);
        }, 60000);
    } else {
        message.reply('No encontr√© stickers para esas palabras clave.');
    }
}


/**
 * Env√≠a un sticker basado en la selecci√≥n numerada realizada por el usuario.
 * 
 * üîπ **Entrada:** 
 *   - `message` *(object)*: Objeto del mensaje de WhatsApp que contiene la informaci√≥n del usuario y el chat.
 *   - `numero` *(number)*: N√∫mero enviado por el usuario para seleccionar un sticker de la lista previamente mostrada.
 * 
 * üîπ **Salida:** 
 *   - No retorna valores, pero env√≠a el sticker seleccionado como respuesta al usuario.
 * 
 * üìå **Descripci√≥n:**
 * - Verifica si el usuario tiene una selecci√≥n activa en `solicitudesStickers`.
 * - Si el usuario **no tiene una selecci√≥n activa**, la funci√≥n simplemente **ignora el mensaje** y no responde.
 * - Si el n√∫mero enviado por el usuario est√° dentro del rango v√°lido:
 *   - Obtiene el sticker correspondiente de la lista previamente mostrada.
 *   - Env√≠a un mensaje confirmando el env√≠o del sticker.
 *   - Espera brevemente y luego env√≠a el sticker seleccionado.
 * - Si el n√∫mero est√° fuera del rango, **no responde**, ya que la validaci√≥n ocurre antes de la llamada a la funci√≥n.
 * 
 * ‚ö† **Nota:**
 * - Esta funci√≥n solo se ejecuta si el usuario ha usado `"quiero stickers de"` y a√∫n tiene una selecci√≥n activa.
 * - No responde si el usuario manda un n√∫mero sin haber solicitado stickers previamente.
 * - El sticker se env√≠a con un retraso de 500 ms para mejorar la experiencia de usuario y evitar bloqueos en WhatsApp.
 */ 
function manejarSeleccionNumerica(message, numero) {
    const solicitud = solicitudesStickers.get(message.from);
    if (!solicitud) return; // Ignorar si no hay una selecci√≥n activa

    if (numero >= 1 && numero <= solicitud.resultados.length) {
        const stickerSeleccionado = solicitud.resultados[numero - 1];
        message.reply(`Enviando sticker: ${stickerSeleccionado}`);
        setTimeout(() => enviarSticker(stickerSeleccionado, message), 500);
    } 
}


// Iniciar cliente
client.initialize();
